<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-bottom: 20px;
        }
        .map-container {
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
    </style>
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Census Data Insights</a>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="text-center mb-4">{{ data.state }} - Analysis</h2>

        <ul class="nav nav-tabs" id="dataTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="total-tab" data-bs-toggle="tab" href="#total" role="tab">Overall Data</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="gender-tab" data-bs-toggle="tab" href="#gender" role="tab">Gender Analysis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="district-tab" data-bs-toggle="tab" href="#district" role="tab">District Analysis</a>
            </li>
        </ul>

        <div class="tab-content" id="dataTabContent">
            <div class="tab-pane fade show active" id="total" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <div id="chart_total"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="map-container">
                            {{ data.map_html | safe }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="gender" role="tabpanel">
                <div class="chart-container">
                    <div id="chart_males"></div>
                </div>
                <div class="chart-container">
                    <div id="chart_females"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="district" role="tabpanel">
                <form action="/visualize_dist" method="post" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <select name="district" class="form-select custom-select" required>
                                <option value="">Select District</option>
                                {% for district in data.district %}
                                <option value="{{ district }}">{{ district }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select name="area_type" class="form-select custom-select" required>
                                <option value="">Select Area Type</option>
                                {% for area in data.dist_area_types %}
                                <option value="{{ area }}">{{ area }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary">Analyze District</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var fig_total = {{ data.fig_json | safe }};
        var fig_males = {{ data.fig_json_males | safe }};
        var fig_females = {{ data.fig_json_females | safe }};

        Plotly.newPlot('chart_total', fig_total.data, fig_total.layout);
        Plotly.newPlot('chart_males', fig_males.data, fig_males.layout);
        Plotly.newPlot('chart_females', fig_females.data, fig_females.layout);

        window.onresize = function() {
            Plotly.relayout('chart_total', {
                'width': document.getElementById('chart_total').clientWidth
            });
            Plotly.relayout('chart_males', {
                'width': document.getElementById('chart_males').clientWidth
            });
            Plotly.relayout('chart_females', {
                'width': document.getElementById('chart_females').clientWidth
            });
        };

        // Initialize map with error handling
        try {
            // Initialize plotly charts
            // ...existing plotly code...

            // Initialize map with error handling
            var mapContainer = document.getElementById('map');
            if (!mapContainer) {
                throw new Error('Map container not found');
            }

            var map = L.map('map').setView([23.5937, 78.9629], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Safe access to geojson data
            var geojsonData = {{ data.geojson | tojson | safe }} || {
                type: 'FeatureCollection',
                features: []
            };

            function getColor(value) {
                value = parseFloat(value) || 0;
                return value > 80 ? '#006d2c' :
                       value > 60 ? '#31a354' :
                       value > 40 ? '#74c476' :
                       value > 20 ? '#bae4b3' :
                                  '#edf8e9';
            }

            function onEachFeature(feature, layer) {
                if (!feature.properties) return;
                
                const stateName = feature.properties.state_name || 'Unknown';
                const literacyRate = parseFloat(feature.properties.literacy_rate || 0);
                
                layer.bindPopup(`
                    <div style="text-align: center;">
                        <h6>${stateName}</h6>
                        <p>Literacy Rate: ${literacyRate.toFixed(2)}%</p>
                    </div>
                `);
                
                layer.on('click', function(e) {
                    if (!stateName || stateName === 'Unknown') return;
                    
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/visualize';
                    form.innerHTML = `
                        <input type="hidden" name="state" value="${stateName}">
                        <input type="hidden" name="area_type" value="Total">
                    `;
                    document.body.appendChild(form);
                    form.submit();
                });
            }

            L.geoJSON(geojsonData, {
                style: function(feature) {
                    return {
                        fillColor: getColor(feature.properties?.literacy_rate),
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: onEachFeature
            }).addTo(map);

            // Add legend
            var legend = L.control({position: 'bottomright'});
            legend.onAdd = function(map) {
                var div = L.DomUtil.create('div', 'info legend');
                var grades = [0, 20, 40, 60, 80];
                div.style.backgroundColor = 'white';
                div.style.padding = '6px 8px';
                div.style.border = '1px solid rgba(0,0,0,0.2)';
                div.style.borderRadius = '4px';
                
                for (var i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(grades[i] + 1) + '; width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7;"></i> ' +
                        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '%<br>' : '+%');
                }
                return div;
            };
            legend.addTo(map);

        } catch (error) {
            console.error('Error initializing map:', error);
            document.querySelector('.map-container').innerHTML = `
                <div class="alert alert-danger">
                    Error loading map data: ${error.message}
                </div>
            `;
        }
    </script>
</body>

</html>